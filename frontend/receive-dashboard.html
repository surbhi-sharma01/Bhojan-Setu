<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bhojan Setu | NGO Dashboard</title>
<style>
  body {
    margin: 0;
    font-family: "Poppins", sans-serif;
    background: #f7f8fa;
    color: #333;
    display: flex;
    height: 100vh;
  }

  /* Sidebar */
  .sidebar {
    width: 230px;
    background: #2c3e50;
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 20px 0;
  }

  .sidebar h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  .nav-links {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 0 15px;
  }

  .nav-links a {
    color: #ecf0f1;
    text-decoration: none;
    padding: 10px;
    border-radius: 8px;
    transition: background 0.3s ease;
  }

  .nav-links a:hover,
  .nav-links a.active {
    background: #27ae60;
    color: #fff;
  }

  .logout-btn {
    text-align: center;
    padding: 12px;
    background: #c0392b;
    border: none;
    color: white;
    font-size: 1rem;
    border-radius: 8px;
    margin: 15px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .logout-btn:hover {
    background: #a93226;
  }

  /* Main Content */
  .main-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }

  header {
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    padding: 15px 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  header .user-info span {
    font-weight: 600;
  }

  main {
    padding: 25px;
    overflow-y: auto;
  }

  .section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 25px;
  }

  .section h3 {
    margin-bottom: 15px;
    color: #27ae60;
    text-align: center;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }

  th, td {
    text-align: left;
    padding: 10px;
    border-bottom: 1px solid #ddd;
  }

  th {
    background-color: #27ae60;
    color: white;
  }

  tr:hover {
    background: #f1f1f1;
  }

  .status {
    font-weight: 600;
  }

  .status.connected { color: #27ae60; }
  .status.waiting { color: #f39c12; }
  .status.expired { color: #e74c3c; }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
  }

  .modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 85vh;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.3s;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 2px solid #27ae60;
    flex-shrink: 0;
  }

  .modal-header h2 {
    margin: 0;
    color: #27ae60;
  }

  .close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s;
  }

  .close:hover {
    color: #000;
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px 30px;
    min-height: 0;
    /* Custom scrollbar styling for better UX */
    scrollbar-width: thin;
    scrollbar-color: #27ae60 #f0f0f0;
  }

  /* Webkit scrollbar styling (Chrome, Safari, Edge) */
  .modal-body::-webkit-scrollbar {
    width: 8px;
  }

  .modal-body::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 4px;
  }

  .modal-body::-webkit-scrollbar-thumb {
    background: #27ae60;
    border-radius: 4px;
  }

  .modal-body::-webkit-scrollbar-thumb:hover {
    background: #219150;
  }

  .donor-info {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 15px 0;
  }

  .donor-info h3 {
    color: #27ae60;
    margin-top: 0;
    margin-bottom: 15px;
  }

  .info-item {
    display: flex;
    align-items: center;
    margin: 12px 0;
    padding: 10px;
    background: white;
    border-radius: 6px;
    border-left: 4px solid #27ae60;
  }

  .info-item strong {
    min-width: 100px;
    color: #555;
  }

  .info-item span {
    color: #333;
    word-break: break-word;
  }

  .clickable-contact {
    color: #27ae60;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s;
    cursor: pointer;
    display: inline-block;
  }

  .clickable-contact:hover {
    color: #219150;
    text-decoration: underline;
  }

  .clickable-contact span {
    color: inherit;
  }

  .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #e0e0e0;
    flex-shrink: 0;
  }

  .contact-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  .contact-btn {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
  }

  .contact-btn.phone {
    background: #27ae60;
    color: white;
  }

  .contact-btn.phone:hover {
    background: #219150;
  }

  .contact-btn.email {
    background: #3498db;
    color: white;
  }

  .contact-btn.email:hover {
    background: #2980b9;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideDown {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @media (max-width: 768px) {
    body { flex-direction: column; }
    .sidebar { width: 100%; flex-direction: row; justify-content: space-around; }
    .main-content { height: auto; }
    .modal-content {
      width: 95%;
      margin: 5% auto;
      max-height: 90vh;
    }
    .modal-header {
      padding: 15px 20px;
    }
    .modal-body {
      padding: 15px 20px;
    }
    .modal-footer {
      padding: 15px 20px;
    }
    .contact-buttons {
      flex-direction: column;
    }
  }
</style>
<script>
  window.API_BASE_URL = 'http://localhost:5000/api';
  function api(url) { return `${window.API_BASE_URL}${url}`; }
</script>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div>
      <h2>Bhojan Setu</h2>
      <div class="nav-links">
        <a href="#" class="active" onclick="showSection('dashboard')">Dashboard</a>
        <a href="#donations" onclick="showSection('available')">Available Donations</a>
        <a href="#claimed" onclick="showSection('claimed')">My Claimed Donations</a>
        <a href="#profile" onclick="showSection('profile')">My Profile</a>
      </div>
    </div>
    <button class="logout-btn" onclick="ngoLogout()">Logout</button>

  </div>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <h2>NGO Dashboard</h2>
      <div class="user-info">
        <span>üë§ NGO:</span> <span id="ngoName">Loading...</span>
      </div>
    </header>

    <main>
      <!-- Dashboard Overview -->
      <section class="section" id="dashboard-section">
        <h3>Dashboard Overview</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
          <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0; color: #27ae60; font-size: 2rem;" id="totalClaimed">0</h4>
            <p style="margin: 5px 0 0 0; color: #555;">Total Claimed</p>
          </div>
          <div style="background: #fff3cd; padding: 20px; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0; color: #f39c12; font-size: 2rem;" id="totalCollected">0</h4>
            <p style="margin: 5px 0 0 0; color: #555;">Collected</p>
          </div>
          <div style="background: #d1ecf1; padding: 20px; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0; color: #3498db; font-size: 2rem;" id="totalDelivered">0</h4>
            <p style="margin: 5px 0 0 0; color: #555;">Delivered</p>
          </div>
        </div>
      </section>

      <!-- Donations Table -->
      <section class="section" id="donations" style="display: none;">
        <h3>Available Donations</h3>
        <table id="donationTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Donor Name</th>
              <th>Food Type</th>
              <th>Quantity</th>
              <th>Pickup Address</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Donations will be loaded dynamically -->
          </tbody>
        </table>
      </section>

      <!-- My Claimed Donations Section -->
      <section class="section" id="claimed" style="display: none;">
        <h3>My Claimed Donations</h3>
        <table id="claimedTable">
          <thead>
            <tr>
              <th>Date Claimed</th>
              <th>Donor Name</th>
              <th>Food Type</th>
              <th>Quantity</th>
              <th>Pickup Address</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Claimed donations will be loaded dynamically -->
          </tbody>
        </table>
      </section>

      <!-- NGO Profile Section -->
      <section class="section" id="profile" style="display: none;">
        <h3>My Profile</h3>
        <p><strong>NGO Name:</strong> <span id="profileName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="profileEmail">Loading...</span></p>
        <p><strong>Phone:</strong> <span id="profilePhone">Loading...</span></p>
        <p><strong>Address:</strong> <span id="profileAddress">Loading...</span></p>
        <p><strong>Member Since:</strong> <span id="memberSince">Loading...</span></p>
      </section>
    </main>
  </div>

  <!-- Donor Contact Info Modal -->
  <div id="donorModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úÖ Donation Claimed Successfully!</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="donor-info">
        <h3>üìû Donor Contact Information</h3>
        <div class="info-item">
          <strong>Name:</strong>
          <span id="modalDonorName">‚Äî</span>
        </div>
        <div class="info-item">
          <strong>Phone:</strong>
          <a href="#" id="modalDonorPhoneLink" class="clickable-contact" onclick="callDonor(); return false;">
            <span id="modalDonorPhone">‚Äî</span>
          </a>
        </div>
        <div class="info-item">
          <strong>Email:</strong>
          <a href="#" id="modalDonorEmailLink" class="clickable-contact" onclick="emailDonor(); return false;">
            <span id="modalDonorEmail">‚Äî</span>
          </a>
        </div>
        <div class="info-item">
          <strong>Address:</strong>
          <span id="modalDonorAddress">‚Äî</span>
        </div>
        <div class="info-item">
          <strong>Pickup Address:</strong>
          <span id="modalPickupAddress">‚Äî</span>
        </div>
        <div class="info-item">
          <strong>Pickup Date:</strong>
          <span id="modalPickupDate">‚Äî</span>
        </div>
        <div class="info-item">
          <strong>Food Type:</strong>
          <span id="modalFoodType">‚Äî</span>
        </div>
        <div class="info-item">
          <strong>Quantity:</strong>
          <span id="modalQuantity">‚Äî</span>
        </div>
        <div class="info-item" id="modalDescription" style="display: none;">
          <strong>Description:</strong>
          <span id="modalDescriptionText">‚Äî</span>
        </div>
        <div class="info-item" id="modalNotes" style="display: none;">
          <strong>Notes:</strong>
          <span id="modalNotesText">‚Äî</span>
        </div>
        <div class="info-item">
          <strong>Claimed At:</strong>
          <span id="modalClaimedAt">‚Äî</span>
        </div>
      </div>
      </div>
      <div class="modal-footer">
        <div class="contact-buttons">
          <button class="contact-btn phone" onclick="callDonor()">
            üìû Call Donor
          </button>
          <button class="contact-btn email" onclick="emailDonor()">
            ‚úâÔ∏è Email Donor
          </button>
        </div>
        <button class="contact-btn" onclick="closeModal()" style="background: #95a5a6; color: white; width: 100%;">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
 
  // For NGO dashboard:
   if (!localStorage.getItem('ngo_token')) {window.location.href = 'receive-login.html';}

    function logout() {
  alert("You have been logged out successfully!");
  window.location.href = "receive-login.html";
}

const donationTable = document.getElementById('donationTable').getElementsByTagName('tbody')[0];

// Function to render donations dynamically
function renderDonationRow(donation) {
  const newRow = donationTable.insertRow(0);
  const dateStr = donation.createdAt ? new Date(donation.createdAt).toLocaleDateString('en-GB') : '‚Äî';
  const donorName = donation.donor?.name || '‚Äî';
  const foodType = donation.foodType || '‚Äî';
  const quantity = donation.quantity || '‚Äî';
  const pickupAddress = donation.pickupAddress || '‚Äî';
  
  // Hide contact info until claimed
  const contactDisplay = donation.status === 'assigned' 
    ? (donation.contactPhone || donation.donor?.phone || '‚Äî')
    : '<span style="color: #999; font-style: italic;">Hidden until claimed</span>';
  
  const statusClass = donation.status === 'assigned' ? 'connected' : 'waiting';
  const statusText = donation.status === 'assigned' ? 'Claimed' : 'Pending';

  newRow.innerHTML = `
    <td>${dateStr}</td>
    <td>${donorName}</td>
    <td>${foodType}</td>
    <td>${quantity}</td>
    <td>${pickupAddress}</td>
    <td>${contactDisplay}</td>
    <td class="status ${statusClass}">${statusText}</td>
    <td>
      ${donation.status === 'pending' 
        ? `<button onclick="claimDonation('${donation._id}', this)" style="background: #27ae60; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Claim</button>` 
        : '<span style="color: #27ae60; font-weight: 600; padding: 8px 16px; background: #e8f5e9; border-radius: 6px; display: inline-block;">‚úì Claimed</span>'}
    </td>
  `;
}

// Store all donations data
let allDonationsData = {};

// Fetch available donations from backend
async function loadAvailableDonations() {
  const token = localStorage.getItem('ngo_token');
  if (!token) return window.location.href = 'receive-login.html';

  try {
    const res = await fetch(api('/donations/available'), {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();

    donationTable.innerHTML = ''; // Clear existing rows

    if (!res.ok) throw new Error(data.message || 'Failed to fetch donations');

    if (!data.data.donations || data.data.donations.length === 0) {
      const row = donationTable.insertRow();
      row.innerHTML = `<td colspan="8" style="text-align:center; color:#888;">No donations available yet.</td>`;
      return;
    }

    // Store all donations data
    allDonationsData = {};
    data.data.donations.forEach(donation => {
      allDonationsData[donation._id] = donation;
      renderDonationRow(donation);
    });

  } catch (err) {
    donationTable.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Error fetching donations.</td></tr>`;
    console.error(err);
  }
}

// Store donation data for modal
let currentDonationData = null;

// Claim a donation and show donor contact info
async function claimDonation(donationId, btn) {
  const token = localStorage.getItem('ngo_token');
  if (!token) return window.location.href = 'receive-login.html';

  // Disable button to prevent double-clicking
  btn.disabled = true;
  btn.textContent = 'Claiming...';
  btn.style.opacity = '0.6';
  btn.style.cursor = 'not-allowed';

  try {
    const res = await fetch(api(`/donations/${donationId}/assign`), {
      method: 'PUT',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();
    
    if (!res.ok) {
      // Re-enable button on error
      btn.disabled = false;
      btn.textContent = 'Claim';
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      throw new Error(data.message || 'Failed to claim donation');
    }

    // Update the row - replace button with "Claimed" status
    const row = btn.closest('tr');
    row.querySelector('.status').textContent = 'Claimed';
    row.querySelector('.status').className = 'status connected';
    btn.outerHTML = '<span style="color: #27ae60; font-weight: 600; padding: 8px 16px; background: #e8f5e9; border-radius: 6px; display: inline-block;">‚úì Claimed</span>';

    // Store donation data with populated donor info from API response
    // Include donorContact info from response
    const donationData = {
      ...data.data.donation,
      donorContact: data.data.donorContact,
      claimedAt: data.data.claimedAt
    };
    currentDonationData = donationData;
    
    // Show modal with donor contact information
    showDonorModal(donationData);

    // Reload to refresh the list (but keep modal open)
    setTimeout(() => {
      loadAvailableDonations();
      loadClaimedDonations(); // Also refresh claimed donations
      updateDashboardStats(); // Update dashboard stats
    }, 100);
  } catch (err) {
    alert(err.message);
  }
}

// Show donor contact info modal
function showDonorModal(donation) {
  const donor = donation.donor || {};
  const donorContact = donation.donorContact || {};
  
  // Use donorContact if available (from API response), otherwise use donation object
  const donorPhone = donorContact.phone || donation.contactPhone || donor.phone || '‚Äî';
  const donorEmail = donorContact.email || donor.email || '‚Äî';
  const donorName = donorContact.name || donor.name || '‚Äî';
  const donorAddress = donorContact.address || donor.address || '‚Äî';
  const pickupAddress = donorContact.pickupAddress || donation.pickupAddress || '‚Äî';
  
  // Populate modal with donor information
  document.getElementById('modalDonorName').textContent = donorName;
  
  // Set clickable phone
  const phoneLink = document.getElementById('modalDonorPhoneLink');
  const phoneSpan = document.getElementById('modalDonorPhone');
  if (donorPhone !== '‚Äî') {
    phoneSpan.textContent = donorPhone;
    phoneLink.href = `tel:${donorPhone}`;
    phoneLink.style.display = 'inline';
  } else {
    phoneSpan.textContent = '‚Äî';
    phoneLink.href = '#';
    phoneLink.style.display = 'none';
  }
  
  // Set clickable email
  const emailLink = document.getElementById('modalDonorEmailLink');
  const emailSpan = document.getElementById('modalDonorEmail');
  if (donorEmail !== '‚Äî') {
    emailSpan.textContent = donorEmail;
    emailLink.href = `mailto:${donorEmail}?subject=Food Donation Pickup - ${donation.foodType || 'Donation'}`;
    emailLink.style.display = 'inline';
  } else {
    emailSpan.textContent = '‚Äî';
    emailLink.href = '#';
    emailLink.style.display = 'none';
  }
  
  document.getElementById('modalDonorAddress').textContent = donorAddress;
  document.getElementById('modalPickupAddress').textContent = pickupAddress;
  document.getElementById('modalPickupDate').textContent = donation.pickupDate 
    ? new Date(donation.pickupDate).toLocaleString('en-GB', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit' 
      }) 
    : '‚Äî';
  document.getElementById('modalFoodType').textContent = donation.foodType || '‚Äî';
  document.getElementById('modalQuantity').textContent = donation.quantity || '‚Äî';
  
  // Show claim timestamp
  const claimedAt = donation.claimedAt || donation.data?.claimedAt;
  document.getElementById('modalClaimedAt').textContent = claimedAt
    ? new Date(claimedAt).toLocaleString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    : new Date().toLocaleString('en-GB', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
  
  // Show description if available
  if (donation.description) {
    document.getElementById('modalDescription').style.display = 'block';
    document.getElementById('modalDescriptionText').textContent = donation.description;
  } else {
    document.getElementById('modalDescription').style.display = 'none';
  }
  
  // Show notes if available
  if (donation.notes) {
    document.getElementById('modalNotes').style.display = 'block';
    document.getElementById('modalNotesText').textContent = donation.notes;
  } else {
    document.getElementById('modalNotes').style.display = 'none';
  }

  // Show modal
  document.getElementById('donorModal').style.display = 'block';
}

// Close modal
function closeModal() {
  document.getElementById('donorModal').style.display = 'none';
  currentDonationData = null;
}

// Call donor
function callDonor() {
  if (!currentDonationData) return;
  const phone = currentDonationData.donorContact?.phone 
    || currentDonationData.contactPhone 
    || currentDonationData.donor?.phone;
  if (phone && phone !== '‚Äî') {
    window.location.href = `tel:${phone}`;
  } else {
    alert('Phone number not available');
  }
}

// Email donor
function emailDonor() {
  if (!currentDonationData) return;
  const email = currentDonationData.donorContact?.email 
    || currentDonationData.donor?.email;
  if (email && email !== '‚Äî') {
    const subject = `Food Donation Pickup - ${currentDonationData.foodType || 'Donation'}`;
    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}`;
  } else {
    alert('Email not available');
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('donorModal');
  if (event.target === modal) {
    closeModal();
  }
}

// Fetch NGO profile
async function loadNGOProfile() {
  const token = localStorage.getItem('ngo_token');
  if (!token) return window.location.href = 'receive-login.html';

  try {
    const res = await fetch(api('/ngos/profile'), {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) return;
    const data = await res.json();

    const ngo = data.data.ngo;
    document.getElementById('ngoName').textContent = ngo.name;
    document.getElementById('profileName').textContent = ngo.name;
    document.getElementById('profileEmail').textContent = ngo.email;
    document.getElementById('profilePhone').textContent = ngo.phone || '‚Äî';
    document.getElementById('profileAddress').textContent = ngo.address || '‚Äî';
    document.getElementById('memberSince').textContent = ngo.createdAt ? new Date(ngo.createdAt).toLocaleDateString('en-GB') : '‚Äî';
  } catch (err) {
    console.error('Error loading NGO profile:', err);
  }
}

// Section navigation
function showSection(section) {
  // Hide all sections
  document.getElementById('dashboard-section').style.display = 'none';
  document.getElementById('donations').style.display = 'none';
  document.getElementById('claimed').style.display = 'none';
  document.getElementById('profile').style.display = 'none';
  
  // Remove active class from all links
  document.querySelectorAll('.nav-links a').forEach(link => {
    link.classList.remove('active');
  });
  
  // Show selected section
  if (section === 'dashboard') {
    document.getElementById('dashboard-section').style.display = 'block';
    document.querySelector('.nav-links a[onclick*="dashboard"]').classList.add('active');
    updateDashboardStats();
  } else if (section === 'available') {
    document.getElementById('donations').style.display = 'block';
    document.querySelector('.nav-links a[onclick*="available"]').classList.add('active');
    loadAvailableDonations();
  } else if (section === 'claimed') {
    document.getElementById('claimed').style.display = 'block';
    document.querySelector('.nav-links a[onclick*="claimed"]').classList.add('active');
    loadClaimedDonations();
  } else if (section === 'profile') {
    document.getElementById('profile').style.display = 'block';
    document.querySelector('.nav-links a[onclick*="profile"]').classList.add('active');
    loadNGOProfile();
  }
}

// Load claimed donations
async function loadClaimedDonations() {
  const token = localStorage.getItem('ngo_token');
  if (!token) return window.location.href = 'receive-login.html';

  const claimedTable = document.getElementById('claimedTable').getElementsByTagName('tbody')[0];

  try {
    const res = await fetch(api('/ngos/claimed-donations'), {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();

    claimedTable.innerHTML = ''; // Clear existing rows

    if (!res.ok) throw new Error(data.message || 'Failed to fetch claimed donations');

    if (!data.data.donations || data.data.donations.length === 0) {
      const row = claimedTable.insertRow();
      row.innerHTML = `<td colspan="8" style="text-align:center; color:#888;">No claimed donations yet.</td>`;
      return;
    }

    data.data.donations.forEach(donation => renderClaimedDonationRow(donation));

  } catch (err) {
    claimedTable.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Error fetching claimed donations.</td></tr>`;
    console.error(err);
  }
}

// Render claimed donation row
function renderClaimedDonationRow(donation) {
  const claimedTable = document.getElementById('claimedTable').getElementsByTagName('tbody')[0];
  const newRow = claimedTable.insertRow(0);
  
  const dateClaimed = donation.claimedAt 
    ? new Date(donation.claimedAt).toLocaleDateString('en-GB') 
    : '‚Äî';
  const donorName = donation.donor?.name || '‚Äî';
  const foodType = donation.foodType || '‚Äî';
  const quantity = donation.quantity || '‚Äî';
  const pickupAddress = donation.pickupAddress || '‚Äî';
  const contactPhone = donation.contactPhone || donation.donor?.phone || '‚Äî';
  const donorEmail = donation.donor?.email || '‚Äî';
  const status = donation.status || 'assigned';
  
  // Status badge styling
  const statusStyles = {
    'assigned': 'background: #fff3cd; color: #856404;',
    'collected': 'background: #d1ecf1; color: #0c5460;',
    'delivered': 'background: #d4edda; color: #155724;'
  };
  
  const statusText = {
    'assigned': 'Claimed',
    'collected': 'Picked Up',
    'delivered': 'Completed'
  };

  // Action buttons based on status
  let actionButtons = '';
  if (status === 'assigned') {
    actionButtons = `<button onclick="updateDonationStatus('${donation._id}', 'collected', this)" style="background: #3498db; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; font-size: 0.9rem;">Mark as Picked Up</button>`;
  } else if (status === 'collected') {
    actionButtons = `<button onclick="updateDonationStatus('${donation._id}', 'delivered', this)" style="background: #27ae60; color: white; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Mark as Completed</button>`;
  } else {
    actionButtons = '<span style="color: #27ae60; font-weight: 600;">‚úì Completed</span>';
  }

  newRow.innerHTML = `
    <td>${dateClaimed}</td>
    <td>${donorName}</td>
    <td>${foodType}</td>
    <td>${quantity}</td>
    <td>${pickupAddress}</td>
    <td>
      <a href="tel:${contactPhone}" style="color: #27ae60; text-decoration: none; font-weight: 600;">${contactPhone}</a>
      <br>
      <a href="mailto:${donorEmail}" style="color: #3498db; text-decoration: none; font-size: 0.9em;">${donorEmail}</a>
    </td>
    <td><span style="padding: 4px 12px; border-radius: 4px; font-weight: 600; ${statusStyles[status] || ''}">${statusText[status] || status}</span></td>
    <td>${actionButtons}</td>
  `;
}

// Update donation status
async function updateDonationStatus(donationId, newStatus, btn) {
  const token = localStorage.getItem('ngo_token');
  if (!token) return window.location.href = 'receive-login.html';

  // Disable button
  btn.disabled = true;
  btn.textContent = 'Updating...';
  btn.style.opacity = '0.6';

  try {
    const res = await fetch(api(`/donations/${donationId}/status`), {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: newStatus })
    });
    const data = await res.json();
    
    if (!res.ok) throw new Error(data.message || 'Failed to update status');

    alert(`Donation marked as ${newStatus === 'collected' ? 'Picked Up' : 'Completed'}!`);
    
    // Reload claimed donations
    loadClaimedDonations();
    updateDashboardStats();
  } catch (err) {
    alert(err.message);
    btn.disabled = false;
    btn.textContent = newStatus === 'collected' ? 'Mark as Picked Up' : 'Mark as Completed';
    btn.style.opacity = '1';
  }
}

// Update dashboard statistics
async function updateDashboardStats() {
  const token = localStorage.getItem('ngo_token');
  if (!token) return;

  try {
    const res = await fetch(api('/ngos/claimed-donations'), {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await res.json();

    if (res.ok && data.data.donations) {
      const donations = data.data.donations;
      const totalClaimed = donations.length;
      const totalCollected = donations.filter(d => d.status === 'collected' || d.status === 'delivered').length;
      const totalDelivered = donations.filter(d => d.status === 'delivered').length;

      document.getElementById('totalClaimed').textContent = totalClaimed;
      document.getElementById('totalCollected').textContent = totalCollected;
      document.getElementById('totalDelivered').textContent = totalDelivered;
    }
  } catch (err) {
    console.error('Error updating dashboard stats:', err);
  }
}

// On page load, fetch profile and donations
loadNGOProfile();
loadAvailableDonations();
updateDashboardStats();


  function ngoLogout() {
    localStorage.removeItem('ngo_token');
    window.location.href = 'receive-login.html';
  }


  
      
  </script>
  


</body>
</html>
